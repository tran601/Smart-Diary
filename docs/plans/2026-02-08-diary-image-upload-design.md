# Smart Diary 日记图片上传设计（2026-02-08）

## 目标

- 在日记编辑界面支持图片上传，入口覆盖：
  - 工具栏按钮上传
  - 拖拽上传
  - 粘贴截图上传
- 传统模式与 AI 模式均可用，且全流程仅本地处理，不产生网络请求。
- 备份导出/导入包含图片附件，恢复后内容可用。

## 方案

### 数据层

- 数据库新增 `diary_attachments` 表，记录图片附件元数据：
  - `diary_id`、`storage_path`、`mime_type`、`file_ext`
  - `size_bytes`、`width`、`height`、`sha256`
  - `source`（`upload | drag | paste`）
  - 时间戳与软删除标记

### 存储层

- 图片实体文件存储在 Electron `userData/images/YYYY/MM/`。
- 日记 HTML 中的 `<img src>` 使用 `smart-diary-media://` 自定义协议 URL。
- 主进程注册协议并映射到本地文件，确保路径可迁移且不暴露 Node API 到渲染进程。

### 上传与压缩

- 渲染进程通过 IPC 提交图片二进制与来源信息。
- 主进程执行图片处理：
  - 最大输入 10MB
  - 最长边缩放到 1920
  - 优先尝试 JPEG 压缩，必要时回退 PNG
- 落盘后写入附件元数据，返回可插入编辑器的 `src`。
- 保存两份文件：
  - 编辑区展示用低分辨率预览图
  - 点击放大时使用的原图文件

### 备份恢复

- 备份导出使用 `.sdbak`，内容包含：
  - 已脱敏数据库（移除 AI API Key）
  - `images/` 下所有附件文件
- 导入优先解析 `.sdbak`；若不是新格式则按旧版 SQLite 单文件兼容导入。

## 边界与约束

- 仅通过 IPC 进行持久化，不在渲染进程直接访问文件系统或数据库。
- 图片上传在传统模式可用，满足离线约束。
- 删除日记时同步清理该日记关联的本地图片文件（预览图与原图）。

## 验证

- `npm run build`（渲染构建 + 主进程 TypeScript 编译）
- `npm run offline-check`（传统模式网络隔离）
- 手动验证：
  - 三入口上传与插入
  - 重启后图片可显示
  - 备份导出后导入，图片仍可访问
